# Juber Eats - uberEats Clone
## Email Verification

mailgun api를 이용하여 회원가입 및 이메일 정보 수정시에 user의 메일 주소로 인증 메일을 전송하고 수신한 메일을 통해 인증을 완료할 수 있는 서비스 구현

- 추가 패키지 : 
	- got : Human-friendly and powerful HTTP request library for Node.js
	- form-data : A library to create readable `"multipart/form-data"` streams. Can be used to submit forms and file uploads to other web applications.

### Verification Entity 

- filed :

	- id(AutoGenerated)
	- user
	- code

- user와 1:1 연관관계를 가지고 있음

	- 유저 생성시 Verification도 DB에 저장하도록 로직 작성
	- 유저 삭제시 join된 verification 레코드도 삭제
	- 테이블에 insert 되는 시점에 code filed에 random constant를 할당

- 유저 모듈에 추가하고 Repository 등록

	```typescript
	@InputType({ isAbstract: true })
	@ObjectType()
	@Entity()
	export class Verification extends CoreEntity {
	  @Column()
	  @Field(() => String)
	  code: string;
	
	  @OneToOne(() => User, { onDelete: 'CASCADE' })
	  @JoinColumn()
	  user: User;
	
	  @BeforeInsert()
	  createCode(): void {
	    this.code = Math.random().toString(36);
	  }
	}
	```

- use entity에 verification filed 추가

	```typescript
	@Field(() => Boolean)
	@Column({ default: false })
	verified: boolean;
	```

	

### EmailModule

- nest-cli를 통해 mail module 생성

- mailgun 회원가입 후 api key, domain, fromEmail 정보를 환경변수에 저장하고 이 환경변수를 옵션에 주입하여 동적으로 모듈을 생성할 수 있도록 함

	- mail.interfaces.ts

		```typescript
		export interface MailModuleOptions {
		  apiKey: string;
		  domain: string;
		  fromEmail: string;
		}
		
		export interface EmailVars {
		  key: string;
		  value: string;
		}
		```

	- mail.module.ts

		```typescript
		@Module({
		  providers: [MailService],
		})
		@Global()
		export class MailModule {
		  static forRoot(options: MailModuleOptions): DynamicModule {
		    return {
		      module: MailModule,
		      exports: [MailService],
		      providers: [
		        {
		          provide: CONFIG_OPTIONS,
		          useValue: options,
		        },
		      ],
		    };
		  }
		}
		```

	- mail.service.ts

		- api를 통해 이메일을 전송하기 위한 값들을 동적으로 생성된 mail 모듈의 provider인 `CONFIG_OPTION`을 주입한다.
		- fomr-data 패키지를 통해 request에 담을 form을 생성하고 이를 got 패키지를 이용하여 mailgun api서버에 전송한다.
		- email 및 verification code를 input으로 받아서 인증메일을 전송한다.

		```typescript
		@Injectable()
		export class MailService {
		  constructor(
		    @Inject(CONFIG_OPTIONS) private readonly options: MailModuleOptions,
		  ) {}
		
		  private async sendEmail(
		    subject: string,
		    template: string,
		    emailVars: EmailVars[],
		  ) {
		    const form = new FormData();
		    form.append(
		      'from',
		      `Jonghyeon from Juber Eats <mailgun@${this.options.domain}>`,
		    );
		    form.append('to', emailVars[0].value);
		    form.append('subject', subject);
		    form.append('template', template);
		    emailVars.forEach((eVar) => form.append(eVar.key, eVar.value));
		    try {
		      const response = await got(
		        `https://api.mailgun.net/v3/${this.options.domain}/messages`,
		        {
		          method: 'POST',
		          headers: {
		            Authorization: `Basic ${Buffer.from(
		              `api:${this.options.apiKey}`,
		            ).toString('base64')}`,
		          },
		          body: form,
		        },
		      );
		    } catch (error) {
		      console.log(error);
		    }
		  }
		
		  sendVerificationEmail(email: string, code: string) {
		    this.sendEmail('Verify You Email', 'email_confirm', [
		      { key: 'v:email', value: email },
		      { key: 'v:code', value: code },
		    ]);
		  }
		}
		```

		

### UserModule

- users.resolver.ts
	- mutation{ verifyEmail } 작성
		- input properties verification.code
		- output: { isOK, error? }

- users.service.ts
	- verificationRepository, mailService 주입
	- createAccount 수정 -> user를 생성, 저장하고 verification도 생성, 저장하도록 한다
	- 주입된 mailService를 통해 user.email, verification.code를 입력받아 인증메일을 보낸다(`sendVerificationEmail(user.email, verification.code)`)
	- verifyEmail 생성 -> 인증메일을 통해 서버에 mutation{ verifyEmail }를 쿼리하도록 하고 code가 일치하는 verification이 존재하면 인증이 완료되는 로직 수행
		- user.verified -> true
		- delete verification recode(인증된 유저와 매핑된 verification) 
		- code가 일치하지 않는다면 인증 실패



### src 구조

```shell

...
├── app.module.ts(수정)
├── mail (*)
│   ├── mail.interfaces.ts (*)
│   ├── mail.module.ts (*)
│   └── mail.service.ts (*)
├── main.ts
...
└── users
    ├── dtos
    │   ├── create-account.dto.ts
    │   ├── edit-profile.dto.ts
    │   ├── login.dto.ts
    │   ├── user.profile.dto.ts
    │   └── verify-email.dto.ts (*)
    ├── entities
    │   ├── users.entity.ts (수정)
    │   └── verification.entity.ts (*)
    ├── users.module.ts 
    ├── users.providers.ts
    ├── users.resolver.ts (수정)
    └── users.service.ts (수정)

```



